// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Category {
  WATER_SUPPLY
  ARCHITECTURAL_BARRIERS
  SEWER_SYSTEM
  PUBLIC_LIGHTING
  WASTE
  ROADS_SIGNS_AND_TRAFFIC_LIGHTS
  ROADS_AND_URBAN_FURNISHINGS
  PUBLIC_GREEN_AREAS_AND_BACKGROUNDS
  OTHER
}

enum ReportStatus {
  PENDING_APPROVAL
  ASSIGNED
  IN_PROGRESS
  SUSPENDED
  REJECTED 
  RESOLVED
}

enum Role {
  ADMIN
  OFFICER
  CITIZEN
}

// Models
model User {
  id            BigInt    @id @default(autoincrement())
  firstName     String    @db.VarChar(100)
  lastName      String    @db.VarChar(100)
  email         String?   @unique @db.VarChar(100)
  username      String    @unique @db.VarChar(100)
  telegram      String?   @unique @db.VarChar(100) 
  role          Role      @default(CITIZEN)
  office        Category?
  passwordHash  String    @db.VarChar(255)

  reportsCreated Report[] @relation("UserReports")

  @@map("user")
}

model MunicipalityUser {
  id            BigInt    @id @default(autoincrement())
  firstName     String    @db.VarChar(100)
  lastName      String    @db.VarChar(100)
  email         String    @unique @db.VarChar(100)
  passwordHash  String    @db.VarChar(255)
  roleId        BigInt
  departmentId  BigInt
  startDate     DateTime? @db.Timestamptz(6)

  roleModel     RoleModel     @relation(fields: [roleId], references: [id])
  department    Department    @relation(fields: [departmentId], references: [id])
  reportsAssigned Report[]    @relation("AssignedReports")

  @@map("municipality_user")
}

model RoleModel {
  id    BigInt  @id @default(autoincrement())
  name  String  @db.VarChar(100)
  level BigInt  

  municipalityUsers MunicipalityUser[] 
  permissions       Permission[]

  @@map("role")
}

model Permission {
  id            BigInt  @id @default(autoincrement())
  name          String  @unique @db.VarChar(100)
  resource      String  @db.VarChar(100)
  action        String  @db.VarChar(100)

  roles RoleModel[]

  @@map("permission")
}

model Department {
  id    BigInt  @id @default(autoincrement())
  name  Category

  addresses         Address[]
  reports           Report[]
  municipalityUsers MunicipalityUser[]

  @@map("department")
}

model Address {
  id          BigInt  @id @default(autoincrement())
  streetName  String  @db.VarChar(200)
  postalCode  String  @db.VarChar(20)
  number      BigInt
  latitude    Decimal @db.Decimal(10,7)
  longitude   Decimal @db.Decimal(10,7)

  departments Department[]

  @@map("address")
}

model Report {
  id                  BigInt        @id @default(autoincrement())
  title               String        @db.VarChar(100)
  description         String        @db.VarChar(500)
  category            Category
  latitude            Decimal       @db.Decimal(10,7)
  longitude           Decimal       @db.Decimal(10,7)
  status              ReportStatus  @default(PENDING_APPROVAL)
  explaination        String?       @db.VarChar(500)
  createdBy           BigInt
  createdAt           DateTime      @default(now())
  assignmentDate      DateTime?     @db.Timestamptz(6)
  assignedEmployee    BigInt?
  assignedDepartment  BigInt?

  user              User              @relation("UserReports", fields: [createdBy], references: [id])
  municipalityUser  MunicipalityUser? @relation("AssignedReports", fields: [assignedEmployee], references: [id])
  department        Department?       @relation(fields: [assignedDepartment], references: [id])
  photos            Photo[]

  @@map("report")
}

model Photo {
  id        BigInt  @id @default(autoincrement())
  size      Int
  url       String
  filename  String  @db.VarChar(255)
  reportId  BigInt

  report    Report  @relation(fields: [reportId], references: [id])

  @@map("photo")
}
